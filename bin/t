#!/usr/bin/env bash

# t: friendly wrapper around tmux.
# attach to tmux session if it exists, or create a new one with no
# args envoke tmux when args are passed

# Make sure even pre-existing tmux sessions use the latest SSH_AUTH_SOCK.
# Inspired by: <https://gist.github.com/lann/6771001>
SOCK_SYMLINK=~/.ssh/ssh_auth_sock
if [[ -r "$SSH_AUTH_SOCK" && ! -L "$SSH_AUTH_SOCK" ]]; then
  ln -sf "$SSH_AUTH_SOCK" "$SOCK_SYMLINK"
fi

# If provided with args, pass them through.
if [[ "$#" -gt 0 ]]; then
  env SSH_AUTH_SOCK="$SOCK_SYMLINK" tmux "$@"
  return 0
fi

__session_exists() {
  tmux list-sessions | sed -E 's/:.*$//' | grep -q "^$SESSION_NAME$"
}

__create_detached_session() {
  (TMUX='' tmux new-session -Ad -s "$SESSION_NAME")
}

# Attach to existing session, or create one, based on current directory.
SESSION_NAME="$(basename "${PWD//[.:]/_}")"

if [[ -z "$TMUX" ]]; then
  env SSH_AUTH_SOCK=$SOCK_SYMLINK tmux new -A -s "$SESSION_NAME"
else
  if ! __session_exists; then __create_detached_session; fi
  tmux switch-client -t "$SESSION_NAME"
fi
